<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Middleware (opium.Opium.Middleware)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> – <a href="../../index.html">opium</a> &#x00BB; <a href="../index.html">Opium</a> &#x00BB; Middleware</nav><h1>Module <code>Opium.Middleware</code></h1><p>Collection of middlewares commonly used to build Opium applications.</p><nav class="toc"><ul><li><a href="#router"><code>router</code></a></li><li><a href="#debugger"><code>debugger</code></a></li><li><a href="#logger"><code>logger</code></a></li><li><a href="#allow_cors"><code>allow_cors</code></a></li><li><a href="#static"><code>static</code></a></li><li><a href="#static_unix"><code>static_unix</code></a></li><li><a href="#content_length"><code>content_length</code></a></li><li><a href="#method_override"><code>method_override</code></a></li><li><a href="#method_required"><code>method_required</code></a></li><li><a href="#etag"><code>etag</code></a></li><li><a href="#head"><code>head</code></a></li></ul></nav></header><section><header><h4 id="router"><a href="#router" class="anchor"></a><code>router</code></h4></header><dl><dt class="spec value" id="val-router"><a href="#val-router" class="anchor"></a><code><span class="keyword">val</span> router : <span><a href="../../../rock/Rock/Handler/index.html#type-t">Rock.Handler.t</a> <a href="../Router/index.html#type-t">Router.t</a></span> <span>&#45;&gt;</span> <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>router router</code> creates a middleware that route the request to an handler depending on the URI of the request.</p><p>The middleware <code>router</code> takes a instance of <code>Router.t</code>. It will call the handler if a match is found in the given list of endpoint, and will fallback to the default handler otherwise.</p><p>The routes can use pattern patching to match multiple endpoints.</p><p>A URI segment preceded with a colon &quot;:&quot; will match any string and will insert the value of the segment in the environment of the request.</p><p>For instance, the middleware defined with:</p><pre><code class="ml">let router =
  Router.add
    Router.empty
    ~action:Handler.hello_world
    ~meth:`GET
    ~route:&quot;/hello/:name&quot;
;;

let middleware = Middleware.router router</code></pre><p>will match any URI that matches &quot;/hello/&quot; followed by a string. This value of the last segment will be inserted in the request environment with the key &quot;name&quot;, and the request will be handled by handler defined in <code>Handler.hello_world</code>.</p><p>Another way to use pattern matching is to use the wildchar &quot;*&quot; character. The URI segment using &quot;*&quot; will match any URI segment, but will not insert the value of the segment in the request enviroment.</p><p>For instance, the middleware defined with:</p><pre><code class="ml">let router =
  Router.add Router.empty ~action:Handler.hello_world ~meth:`GET ~route:&quot;/*/hello&quot;
;;

let middleware = Middleware.router router</code></pre><p>will redirect any URI containing two segments with the last segment containing &quot;hello&quot; to the handler defined in <code>Handler.hello_world</code>.</p></dd></dl></section><section><header><h4 id="debugger"><a href="#debugger" class="anchor"></a><code>debugger</code></h4></header><dl><dt class="spec value" id="val-debugger"><a href="#val-debugger" class="anchor"></a><code><span class="keyword">val</span> debugger : <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>debugger</code> creates a middleware that that catches any error that occurs when processing the request and pretty prints the error in an an HTML page.</p><p>It should only be used during development: you probably don't want to serve a detail of the error to your users in production.</p></dd></dl></section><section><header><h4 id="logger"><a href="#logger" class="anchor"></a><code>logger</code></h4></header><dl><dt class="spec value" id="val-logger"><a href="#val-logger" class="anchor"></a><code><span class="keyword">val</span> logger : <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>logger</code> creates a middleware that logs the requests and their response.</p><p>The request's target URL and the HTTP method are logged with the &quot;info&quot; verbosity. Once the request has been processed successfully, the response's HTTP code is logged with the &quot;info&quot; verbosity.</p><p>If the body of the request or the response are a string (as opposed to a stream), their content is logged with the &quot;debug&quot; verbosity.</p><p>If an error occurs while processing the request, the error is logged with an &quot;error&quot; verbosity.</p><p>Note that this middleware is best used as the first middleware of the pipeline because any previous middleware might change the request / response after <code>Logger</code> has been applied.</p></dd></dl></section><section><header><h4 id="allow_cors"><a href="#allow_cors" class="anchor"></a><code>allow_cors</code></h4></header><dl><dt class="spec value" id="val-allow_cors"><a href="#val-allow_cors" class="anchor"></a><code><span class="keyword">val</span> allow_cors : <span>?&#8288;origins:<span>string list</span></span> <span>&#45;&gt;</span> <span>?&#8288;credentials:bool</span> <span>&#45;&gt;</span> <span>?&#8288;max_age:int</span> <span>&#45;&gt;</span> <span>?&#8288;headers:<span>string list</span></span> <span>&#45;&gt;</span> <span>?&#8288;expose:<span>string list</span></span> <span>&#45;&gt;</span> <span>?&#8288;methods:<span><a href="../Method/index.html#type-t">Method.t</a> list</span></span> <span>&#45;&gt;</span> <span>?&#8288;send_preflight_response:bool</span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>allow_cors ?origins ?credentials ?max_age ?headers ?expose ?methods
      ?send_preflight_response ()</code> creates a middleware that adds Cross-Origin Resource Sharing (CORS) header to the responses.</p></dd></dl></section><section><header><h4 id="static"><a href="#static" class="anchor"></a><code>static</code></h4></header><dl><dt class="spec value" id="val-static"><a href="#val-static" class="anchor"></a><code><span class="keyword">val</span> static : <span>read:<span>(string <span>&#45;&gt;</span> <span><span>(<a href="../Body/index.html#type-t">Body.t</a>, <span>[ <a href="../Status/index.html#type-client_error">Status.client_error</a> <span>| <a href="../Status/index.html#type-server_error">Status.server_error</a></span> ]</span>)</span> Lwt_result.t</span>)</span></span> <span>&#45;&gt;</span> <span>?&#8288;uri_prefix:string</span> <span>&#45;&gt;</span> <span>?&#8288;headers:<a href="../Headers/index.html#type-t">Headers.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;etag_of_fname:<span>(string <span>&#45;&gt;</span> <span>string option</span>)</span></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>static ~read ?uri_prefix ?headers ?etag_of_fname ()</code> creates a middleware that is used to serve static content.</p><p>It is Unix-independent, you can provide your own read function that could read from in-memory content, or read a Unix filesystem, or even connect to a third party service such as S3.</p><p>The responses will contain a <code>Content-type</code> header that is auto-detected based on the file extension using the <span class="xref-unresolved" title="unresolved reference to &quot;Magic_mime.lookup&quot;"><code>Magic_mime</code>.lookup</span> function. Additional headers can be provided through <code>headers</code>.</p><p>It supports the HTTP entity tag (ETag) protocol to provide web cache validation. If <code>etag_of_fname</code> is provided, the response will contain an <code>ETag</code> header. If the request contains an <code>If-None-Match</code> header with an <code>ETag</code> equal to that generated by <code>etag_of_fname</code>, this middleware will respond with <code>304 Not Modified</code>.</p></dd></dl></section><section><header><h4 id="static_unix"><a href="#static_unix" class="anchor"></a><code>static_unix</code></h4></header><dl><dt class="spec value" id="val-static_unix"><a href="#val-static_unix" class="anchor"></a><code><span class="keyword">val</span> static_unix : <span>local_path:string</span> <span>&#45;&gt;</span> <span>?&#8288;uri_prefix:string</span> <span>&#45;&gt;</span> <span>?&#8288;headers:<a href="../Headers/index.html#type-t">Headers.t</a></span> <span>&#45;&gt;</span> <span>?&#8288;etag_of_fname:<span>(string <span>&#45;&gt;</span> <span>string option</span>)</span></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>static_unix ~local_path ?uri_prefix ?headers ?etag_of_fname ()</code> creates a middleware that is used to serve static content from a local filesystem.</p><p>The behaviour of the middleware is the same as <a href="index.html#static"><span><code>static</code></span></a>, since the latter is used with a <code>read</code> function that reads from the local filesystem.</p></dd></dl></section><section><header><h4 id="content_length"><a href="#content_length" class="anchor"></a><code>content_length</code></h4></header><dl><dt class="spec value" id="val-content_length"><a href="#val-content_length" class="anchor"></a><code><span class="keyword">val</span> content_length : <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>content_length</code> is middleware that overrides the request's <code>POST</code> method with the method defined in the <code>_method</code> request parameter.</p><p>The <code>POST</code> method can be overridden by the following HTTP methods:</p><ul><li><code>PUT</code></li><li><code>PATCH</code></li><li><code>DELETE</code></li></ul></dd></dl></section><section><header><h4 id="method_override"><a href="#method_override" class="anchor"></a><code>method_override</code></h4></header><dl><dt class="spec value" id="val-method_override"><a href="#val-method_override" class="anchor"></a><code><span class="keyword">val</span> method_override : <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>method_override</code> is a middleware that replaces the HTTP method with the one found in the <code>_method</code> field of <code>application/x-www-form-urlencoded</code> encoded <code>POST</code> requests.</p><p>Requests that are not <code>application/x-www-form-urlencoded</code> encoded or with method different than <code>POST</code> remain untouched.</p><p>This is especially useful when sending requests from HTML form, because they only support the <code>GET</code> and <code>POST</code> method.</p></dd></dl></section><section><header><h4 id="method_required"><a href="#method_required" class="anchor"></a><code>method_required</code></h4></header><dl><dt class="spec value" id="val-method_required"><a href="#val-method_required" class="anchor"></a><code><span class="keyword">val</span> method_required : <span>?&#8288;allowed_methods:<span><a href="../Method/index.html#type-t">Method.t</a> list</span></span> <span>&#45;&gt;</span> unit <span>&#45;&gt;</span> <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>method_required</code> creates a middleware that filters the requests by method and respond with a <code>`Method_not_allowed</code> status (<code>HTTP 405</code>) if the method is not allowed.</p></dd></dl></section><section><header><h4 id="etag"><a href="#etag" class="anchor"></a><code>etag</code></h4></header><dl><dt class="spec value" id="val-etag"><a href="#val-etag" class="anchor"></a><code><span class="keyword">val</span> etag : <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>etag</code> is a middleware that adds an ETag header to responses and respond with the HTTP code <code>304</code> when the computed ETag matches the one specified in the request.</p></dd></dl></section><section><header><h4 id="head"><a href="#head" class="anchor"></a><code>head</code></h4></header><dl><dt class="spec value" id="val-head"><a href="#val-head" class="anchor"></a><code><span class="keyword">val</span> head : <a href="../../../rock/Rock/Middleware/index.html#type-t">Rock.Middleware.t</a></code></dt><dd><p><code>head</code> is a middleware that add supports for <code>HEAD</code> request for handlers that receive <code>GET</code> requests.</p><p>It works by replacing the <code>HEAD</code> method by the <code>GET</code> method before sending the request to the handler, and removes the body of the response before sending it to the client.</p></dd></dl></section></div></body></html>